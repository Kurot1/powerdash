<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì „ë ¥ ì‚¬ìš©ëŸ‰ ëŒ€ì‹œë³´ë“œ â€” Neon Pro</title>

  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    /* =========================
       ë‹¤í¬ ë„¤ì˜¨ ë¸”ë£¨ í…Œë§ˆ ìŠ¤íƒ€ì¼
       ========================= */
    :root{
      --bg          : #071026; /* ì•„ì£¼ ì§™ì€ ë„¤ì´ë¹„/ë¸”ë™ */
      --panel       : linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --card        : rgba(255,255,255,0.03);
      --glass       : rgba(255,255,255,0.03);
      --muted       : #93a5c6;
      --text        : #e6f0ff;
      --accent      : #00b7ff; /* ë„¤ì˜¨ ë¸”ë£¨ */
      --accent-2    : #5af6d6; /* ë¯¼íŠ¸ í¬ì¸íŠ¸ */
      --danger      : #ff6b6b;
      --radius      : 12px;
      --shadow      : 0 10px 30px rgba(2,6,23,0.75), inset 0 1px 0 rgba(255,255,255,0.02);
      --glass-border: rgba(255,255,255,0.04);
      --small      : 13px;
      --base       : 15px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, ui-sans-serif, system-ui, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(0,183,255,0.04), transparent),
                  radial-gradient(1000px 500px at 90% 90%, rgba(90,246,214,0.02), transparent),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
    }

    /* header */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:18px 24px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.012));
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
      margin-bottom:20px;
      backdrop-filter: blur(6px) saturate(1.2);
    }
    header .title {
      display:flex;
      gap:14px;
      align-items:center;
    }
    .logo {
      width:46px; height:46px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, rgba(0,183,255,0.12), rgba(90,246,214,0.06));
      border:1px solid rgba(0,183,255,0.14);
      box-shadow: 0 6px 18px rgba(0,183,255,0.06);
      font-weight:700;
      color:var(--accent);
      font-size:18px;
    }
    header h1{
      margin:0; font-size:18px; letter-spacing: -0.2px;
    }
    header p { margin:0; color:var(--muted); font-size:13px }

    /* layout */
    main {
      width: 100%;
      max-width:1300px;
      margin:0 auto;
      display:block;
      grid-template-columns: 360px 1fr;
      gap:20px;
      align-items:start;
    }

    /* left panel (controls) */
    .panel {
      width: 100%;
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      border:1px solid var(--glass-border);
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      min-height:420px;
      margin-bottom: 20px;
    }
    .panel .section-title{
      font-weight:700;
      font-size:13px;
      color:var(--text);
      margin-bottom:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
    }
    .muted { color:var(--muted); font-size:13px; }

    .control-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    label { display:flex; flex-direction:column; color:var(--muted); font-size:12px; gap:6px; }
    input[type="text"], input[type="number"], select{
      background: rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.04);
      padding:10px 12px;
      border-radius:10px;
      color:var(--text);
      font-size:14px;
      min-width:120px;
      outline:none;
      transition: all .12s ease;
      box-shadow: none;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus{
      box-shadow: 0 6px 20px rgba(0,183,255,0.07);
      border-color: rgba(0,183,255,0.9);
    }

    /* mode buttons */
    .modes { display:flex; gap:8px; margin-top:6px; }
    .mode-btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.04);
      cursor:pointer;
      background: transparent;
      color:var(--text);
      font-weight:600;
      font-size:13px;
      transition: all .12s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    /* ê¸°ì¡´ .mode-btn.primary/.ghost ìœ ì§€ */
.mode-btn.primary {
  background: linear-gradient(90deg, rgba(0,183,255,0.12), rgba(90,246,214,0.06));
  border: 1px solid rgba(0,183,255,0.28);
  box-shadow: 0 8px 24px rgba(0,183,255,0.06);
  color: var(--accent);
  font-size: 13px;
  padding: 10px 12px;
}

.mode-btn.ghost {
  background: transparent;
  font-size: 13px;
  padding: 10px 12px;
}

button.primary {
  background: linear-gradient(90deg, rgba(0,183,255,0.18), rgba(90,246,214,0.09));
  border: 1px solid rgba(0,183,255,0.25);
  color: var(--text);
  padding: 10px 16px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: all .15s ease;
}

button.primary:hover {
  border-color: rgba(0,183,255,0.55);
  box-shadow: 0 8px 24px rgba(0,183,255,0.12);
}

/* ì§€ë„ë³´ê¸° ë²„íŠ¼ë§Œ í¬ê²Œ ê°•ì¡° */
.btn-map {
  background: #00b7ff;
  color: #ffffff;
  font-weight: 700;
  font-size: 16px;       /* ê¸€ì”¨ ì¡°ê¸ˆ ë” í¼ */
  padding: 12px 22px;    /* ë²„íŠ¼ ì „ì²´ í¬ê¸° ë” í¼ */
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-map:hover {
  background: #0096e6;
  transform: scale(1.03);
}

.btn-map.active {
  box-shadow: 0 10px 30px rgba(0,183,255,0.35);
}

    /* cards on right */
    .canvas {
      display:flex; flex-direction:column; gap:18px;
      width: 100%;
    }
    .card {
      width: 100%;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;
      border:1px solid var(--glass-border);
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    
    
    .example-panel {
      margin-bottom: 20px;
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .example-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .example-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .example-row label {
      flex: 1;
      min-width: 180px;
    }

    .example-panel textarea,
    .example-panel input,
    .example-panel select {
      width: 100%;
      min-height: 180px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(0,183,255,0.18);
      border-radius: 12px;
      padding: 14px;
      color: var(--text);
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 13px;
      resize: vertical;
      line-height: 1.5;
    }

    .example-panel textarea:focus {
      outline: none;
      border-color: rgba(0,183,255,0.5);
      box-shadow: 0 12px 30px rgba(0,183,255,0.08);
    }

    .example-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 10px;
      align-items: center;
    }

    .example-status {
      font-size: 12px;
      color: var(--muted);
      min-height: 18px;
    }

    .example-status.error {
      color: var(--danger);
    }
    .usage-section {
      padding: 22px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .usage-section h2 {
      margin: 6px 0 0;
    }
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .insight-card {
      padding: 14px;
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.04);
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 92px;
    }
    .insight-card .label { font-size: 12px; color: var(--muted); }
    .insight-card .value { font-size: 20px; font-weight: 700; }
    .insight-card .sub { font-size: 12px; color: var(--muted); }

    .usage-chart {
      width: 100%;
      background: rgba(255,255,255,0.01);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 16px;
    }
    .usage-chart canvas { width: 100%; }

    .facility-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .facility-card {
      border: 1px solid rgba(255,255,255,0.04);
      padding: 12px;
      border-radius: 12px;
      background: rgba(0,183,255,0.02);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .tips-panel {
      border-top: 1px solid rgba(255,255,255,0.04);
      padding-top: 12px;
    }
    .tips-panel ul {
      list-style: none;
      padding: 0;
      margin: 10px 0 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .tips-panel li {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px dashed rgba(0,183,255,0.3);
      background: rgba(0,183,255,0.05);
      font-size: 14px;
    }


    /* mini stat */
    .stat-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; margin-bottom:6px; }
    .stat {
      padding:12px; border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border: 1px solid rgba(255,255,255,0.02);
      display:flex; flex-direction:column; gap:6px;
    }
    .stat .label { color:var(--muted); font-size:12px; }
    .stat .value { font-weight:800; color:var(--text); font-size:18px; }

    /* chart container */
    #chart {
  width: 100%;      /* ë„ˆë¹„ë¥¼ í™”ë©´ ì „ì²´ë¡œ */
  height: 70vh;     /* ë†’ì´ëŠ” í™”ë©´ ë¹„ìœ¨ë¡œ ìë™ ì¡°ì ˆ */
  border-radius: 12px;
  overflow: hidden;
  background: linear-gradient(180deg, rgba(2,8,22,0.55), rgba(2,8,22,0.45));
  border: 1px solid rgba(255,255,255,0.02);
}


    /* footer small hints */
    .hint { color:var(--muted); font-size:12px; margin-top:8px; }

    /* responsive */
    @media (max-width:1100px){
      main { grid-template-columns: 1fr; padding:16px; }
      #chart { height:520px; }
      .stat-grid { grid-template-columns: repeat(2,1fr); }
      .facility-summary { grid-template-columns: 1fr; }
    }
    @media (max-width:600px){
      header { flex-direction:column; align-items:flex-start; gap:8px; }
      .stat-grid { grid-template-columns: 1fr; }
    }

    /* small utility */
    .right { margin-left:auto; }
    .tiny { font-size:12px; color:var(--muted) }

    /* subtle neon accent for x-axis labels overflow */
    .chip {
      background: rgba(0,183,255,0.06);
      border: 1px solid rgba(0,183,255,0.12);
      padding:6px 10px; border-radius:999px; color:var(--accent);
      font-weight:700; font-size:13px;
    }

    /* hidden option fallback: option doesn't support style across browsers consistently,
       so we will hide by removing the option node when needed (JS handles it). */

       /* select ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
select {
  background: rgba(0,0,0,0.3); /* ì§„í•œ ë°°ê²½ */
  color: #ffffff;              /* ê¸€ì”¨ í°ìƒ‰ */
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px 12px;
  font-size: 14px;
  outline: none;
  transition: all 0.12s ease;
}

/* ì„ íƒëœ ì˜µì…˜ */
select option {
  background: #1c1f26; /* ì˜µì…˜ ë°°ê²½ ì–´ë‘¡ê²Œ */
  color: #ffffff;       /* ê¸€ì”¨ í°ìƒ‰ */
}

/* hover / focus íš¨ê³¼ */
select:focus {
  border-color: var(--accent);
  box-shadow: 0 6px 20px rgba(0,183,255,0.2);
}
select option:hover {
  background: #2a2e36;
}

  </style>
</head>
<body>
  <header>
    <h2>ì „ë ¥ ì†Œë¹„ëŸ‰ ëŒ€ì‹œë³´ë“œ</h2>
  </header>

  <main>
    <section class="card example-panel">
      <div class="section-title">ì§ì ‘ ì˜ˆì‹œ ì…ë ¥</div>
      <p class="muted tiny">period, facilities, tips í•„ë“œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•œ ë’¤ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¸ì‚¬ì´íŠ¸ ì˜ì—­ì´ ì¦‰ì‹œ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
      <textarea id="exampleInput" spellcheck="false"></textarea>
      <div class="example-actions">
        <span class="example-status" id="exampleStatus">ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        <button class="mode-btn ghost" id="btnExampleFill" type="button">ì˜ˆì‹œ ê°’ ì±„ìš°ê¸°</button>
        <button class="primary" id="btnExampleApply" type="button">ì…ë ¥ê°’ ì¸ì‚¬ì´íŠ¸ ë³´ê¸°</button>
      </div>
    </section>
     <section class="card usage-section" id="usageSection">
      <div class="section-title">
        <div class="chip">ìƒ˜í”Œ ì‚¬ìš©ëŸ‰ ì¸ì‚¬ì´íŠ¸</div>
        <h2>ì‹œê°„ëŒ€ë³„ ì „ë ¥ íë¦„</h2>
        <p class="muted" id="usagePeriod">ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
      <div class="insights-grid" id="usageKpis"></div>
      <div class="usage-chart">
        <canvas id="usageChart" height="120"></canvas>
      </div>
      <div class="facility-summary" id="facilitySummary"></div>
      <div class="tips-panel">
        <h3>ì ˆê° íŒ</h3>
        <ul id="usageTips"></ul>
      </div>
    </section>
    <!-- ìƒë‹¨ ëª¨ë“œ ì„ íƒ -->
    <div class="toolbar">
      <label>ì—°ë„
        <input id="year" type="text" placeholder="ì˜ˆ: 2020" value="2020">
      </label>
      <label>ì›”
        <input id="month" type="text" placeholder="ì˜ˆ: 11" value="11">
      </label>
      <label id="metricLabel">ì§€í‘œ
        <div style="display:flex; gap:8px; align-items:flex-end;">
        <button class="mode-btn primary" id="btnIndustry">ì‚°ì—…ë¶„ë¥˜ Top-N</button>
        <button class="mode-btn ghost" id="btnBizType">ì—…ì¢…ë³„(ì‹œêµ°êµ¬)</button>
        <button class="btn-map" id="btnMap">ğŸ—º ì§€ë„ë³´ê¸°</button>
      </div>
        <select id="metric">
          <option value="kwh" selected>kWh(ì „ë ¥ì†Œë¹„ëŸ‰)</option>
          <option value="bill">ìš”ê¸ˆ(ì›)</option>
        </select>
      </label>
    </div>

    <!-- ì‚°ì—…ë¶„ë¥˜ Top-N -->
    <div class="card" id="industryRow">
      <div class="section-title">ì‚°ì—…ë¶„ë¥˜ Top-N ì¡°íšŒ</div>
      <div class="toolbar">
        <label>Top N
          <input id="topN" type="number" min="3" max="30" value="10" style="width:80px">
        </label>
        <label>ì‹œë„
          <select id="metroSel">
            <option value="">ì „ì²´(ì„ íƒ ì•ˆí•¨)</option>
            <option value="11">ì„œìš¸íŠ¹ë³„ì‹œ</option>
            <option value="26">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
            <option value="27">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
            <option value="28">ì¸ì²œê´‘ì—­ì‹œ</option>
            <option value="29">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
            <option value="30">ëŒ€ì „ê´‘ì—­ì‹œ</option>
            <option value="31">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
            <option value="36">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
            <option value="41">ê²½ê¸°ë„</option>
            <option value="42">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
            <option value="43">ì¶©ì²­ë¶ë„</option>
            <option value="44">ì¶©ì²­ë‚¨ë„</option>
            <option value="45">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
            <option value="46">ì „ë¼ë‚¨ë„</option>
            <option value="47">ê²½ìƒë¶ë„</option>
            <option value="48">ê²½ìƒë‚¨ë„</option>
            <option value="50">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
          </select>
        </label>
        <label>ì‹œêµ°êµ¬
          <select id="citySel" disabled>
            <option value="">ì „ì²´(ì„ íƒ ì•ˆí•¨)</option>
          </select>
        </label>
        <button class="primary" id="btnIndustryLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <!-- ì—…ì¢…ë³„(ì‹œêµ°êµ¬) -->
    <div class="card" id="biztypeRow" style="display:none">
      <div class="section-title">ì—…ì¢…ë³„(ì‹œêµ°êµ¬) ì¡°íšŒ</div>
      <div class="toolbar">
        <label>ì‹œë„
          <select id="metroSel2">
            <option value="">ì‹œë„ ì„ íƒ</option>
            <option value="11">ì„œìš¸íŠ¹ë³„ì‹œ</option>
            <option value="26">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
            <option value="27">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
            <option value="28">ì¸ì²œê´‘ì—­ì‹œ</option>
            <option value="29">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
            <option value="30">ëŒ€ì „ê´‘ì—­ì‹œ</option>
            <option value="31">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
            <option value="36">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
            <option value="41">ê²½ê¸°ë„</option>
            <option value="42">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
            <option value="43">ì¶©ì²­ë¶ë„</option>
            <option value="44">ì¶©ì²­ë‚¨ë„</option>
            <option value="45">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
            <option value="46">ì „ë¼ë‚¨ë„</option>
            <option value="47">ê²½ìƒë¶ë„</option>
            <option value="48">ê²½ìƒë‚¨ë„</option>
            <option value="50">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
          </select>
        </label>
        <label>ì‹œêµ°êµ¬
          <select id="citySel2" disabled>
            <option value="">ì‹œêµ°êµ¬ ì„ íƒ</option>
          </select>
        </label>
        <button class="primary" id="btnBizLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <div id="chart"></div>
  </main>

<script>
  const FALLBACK_SAMPLE = {
  period: '2024-06-01',
  facilities: [
    {
      id: 'hq',
      name: 'ì„œìš¸ ë³¸ì‚¬',
      category: 'ì˜¤í”¼ìŠ¤',
      baseline: 820,
      usage: [
        { hour: '00:00', kwh: 32 },
        { hour: '03:00', kwh: 28 },
        { hour: '06:00', kwh: 46 },
        { hour: '09:00', kwh: 78 },
        { hour: '12:00', kwh: 96 },
        { hour: '15:00', kwh: 84 },
        { hour: '18:00', kwh: 72 },
        { hour: '21:00', kwh: 54 }
      ]
    },
    {
      id: 'smart-factory',
      name: 'ìŠ¤ë§ˆíŠ¸ ê³µì¥',
      category: 'ì œì¡°',
      baseline: 1340,
      usage: [
        { hour: '00:00', kwh: 88 },
        { hour: '03:00', kwh: 76 },
        { hour: '06:00', kwh: 110 },
        { hour: '09:00', kwh: 162 },
        { hour: '12:00', kwh: 174 },
        { hour: '15:00', kwh: 188 },
        { hour: '18:00', kwh: 142 },
        { hour: '21:00', kwh: 116 }
      ]
    },
    {
      id: 'logistics',
      name: 'ë™íƒ„ ë¬¼ë¥˜ì„¼í„°',
      category: 'ë¬¼ë¥˜',
      baseline: 640,
      usage: [
        { hour: '00:00', kwh: 40 },
        { hour: '03:00', kwh: 32 },
        { hour: '06:00', kwh: 44 },
        { hour: '09:00', kwh: 72 },
        { hour: '12:00', kwh: 90 },
        { hour: '15:00', kwh: 76 },
        { hour: '18:00', kwh: 58 },
        { hour: '21:00', kwh: 46 }
      ]
    }
  ],
  tips: [
    'ì ì‹¬ í”¼í¬(12~15ì‹œ) ì§ì „ ì˜ˆì—´/ì˜ˆëƒ‰ ì œì–´ë¡œ ìŠ¤ë§ˆíŠ¸ê³µì¥ ìˆ˜ìš”ë¥¼ 6% ì ˆê°',
    'ë¬¼ë¥˜ì„¼í„° ì¶œê³  í”¼í¬ ì´í›„ ì¡°ëª… êµ¬ì—­ ì œì–´ ìë™í™”',
    'ë³¸ì‚¬ ì•¼ê°„ ì”ë¥˜ ë¶€í•˜ë¥¼ ì¸¡ì •í•˜ì—¬ 5kWh ì´í•˜ë¡œ ê³ ì •',
    'ì„¤ë¹„ë³„ ê³„ì•½ ì „ë ¥ì„ ì¬ì ê²€í•´ ê¸°ë³¸ìš”ê¸ˆ ì´ˆê³¼ë¶„ì„ ë°©ì§€'
  ]
};
const chart = echarts.init(document.getElementById('chart'));
let usageLineChart = null;
const z2 = (m)=>String(m??'').padStart(2,'0');
const getYM = ()=>({ year:year.value.trim(), month:z2(month.value.trim()) });
const metricKey = ()=>metric.value;

const exampleInput = document.getElementById('exampleInput');
const exampleStatus = document.getElementById('exampleStatus');
const btnExampleApply = document.getElementById('btnExampleApply');
const btnExampleFill = document.getElementById('btnExampleFill');
let exampleTemplate = FALLBACK_SAMPLE;

if (exampleInput) {
  exampleInput.value = JSON.stringify(FALLBACK_SAMPLE, null, 2);
}

const formatKwh = value => `${Math.round(Number(value || 0)).toLocaleString()} kWh`;
const formatPercent = value => `${value > 0 ? '+' : ''}${value.toFixed(1)}%`;

const toNumber = value => {
  if (typeof value === 'number') return value;
  if (typeof value === 'string') return Number(value.replace(/,/g, '')) || 0;
  return Number(value) || 0;
};

const sumFacilityUsageLocal = facility =>
  (facility?.usage || []).reduce((total, point) => total + toNumber(point.kwh), 0);

const aggregateTimelineLocal = facilities => {
  const bucket = new Map();
  facilities.forEach(facility => {
    (facility?.usage || []).forEach(point => {
      const hour = String(point.hour ?? '');
      if (!hour) return;
      const prev = bucket.get(hour) || 0;
      bucket.set(hour, prev + toNumber(point.kwh));
    });
  });
  return Array.from(bucket.entries())
    .map(([hour, kwh]) => ({ hour, kwh }))
    .sort((a, b) => a.hour.localeCompare(b.hour));
};

const calcGrowthRateLocal = timeline => {
  if (!timeline.length) return { absolute: 0, percentage: 0 };
  const first = timeline[0];
  const last = timeline[timeline.length - 1];
  const absolute = last.kwh - first.kwh;
  const percentage = first.kwh ? (absolute / first.kwh) * 100 : 0;
  return { absolute, percentage };
};

function summarizeUsageInput(payload = {}) {
  const facilities = Array.isArray(payload.facilities) ? payload.facilities : [];
  const normalized = facilities.map(facility => ({
    ...facility,
    usage: Array.isArray(facility.usage)
      ? facility.usage.map(point => ({
          hour: String(point.hour ?? ''),
          kwh: toNumber(point.kwh)
        })).filter(point => point.hour)
      : []
  }));

  const facilityTotals = normalized.map(f => ({
    id: f.id,
    name: f.name,
    category: f.category,
    total: sumFacilityUsageLocal(f),
    baseline: f.baseline
  }));

  const timeline = aggregateTimelineLocal(normalized);
  const totalKwh = timeline.reduce((sum, point) => sum + point.kwh, 0);
  const averageUsage = timeline.length ? totalKwh / timeline.length : 0;

  const highestUsage = facilityTotals.reduce((prev, current) =>
    !prev || current.total > prev.total ? current : prev,
  null);

  const lowestUsage = facilityTotals.reduce((prev, current) =>
    !prev || current.total < prev.total ? current : prev,
  null);

  const peakHour = timeline.reduce((prev, current) =>
    !prev || current.kwh > prev.kwh ? current : prev,
  null);

  const growthRate = calcGrowthRateLocal(timeline);

  return {
    period: payload.period || 'ì‚¬ìš©ì ì…ë ¥',
    facilities: normalized,
    tips: Array.isArray(payload.tips) ? payload.tips : [],
    facilityTotals,
    timeline,
    insights: {
      highestUsage,
      lowestUsage,
      averageUsage,
      peakHour,
      growthRate,
    }
  };
}

function setExampleStatus(message, variant = 'info') {
  if (!exampleStatus) return;
  exampleStatus.textContent = message;
  exampleStatus.classList.toggle('error', variant === 'error');
}

function applyUsagePayload(payload, { context = 'sample' } = {}) {
  const summary = summarizeUsageInput(payload);
  const labelBase = summary.period || (context === 'example' ? 'ì‚¬ìš©ì ì…ë ¥ ë°ì´í„°' : 'ìƒ˜í”Œ ë°ì´í„°');
  const labelSuffix = context === 'example' ? ' Â· ì‚¬ìš©ì ì…ë ¥' : ' ê¸°ì¤€ ìƒ˜í”Œ';
  document.getElementById('usagePeriod').textContent = `${labelBase}${labelSuffix}`;
  renderUsageKpis(summary.insights || {});
  renderUsageChart(summary.timeline || []);
  renderFacilitySummary(summary.facilityTotals || []);
  renderUsageTips(summary.tips || []);
}


async function fetchUsageInsights(){
  try {
    const res = await axios.get('/api/usage');
    const data = res.data || {};
    const basePayload = {
      period: data.period,
      facilities: data.facilities || [],
      tips: data.tips || []
    };
    exampleTemplate = basePayload;
    if (exampleInput) {
      exampleInput.value = JSON.stringify(basePayload, null, 2);
    }
    applyUsagePayload(basePayload, { context: 'sample' });
    setExampleStatus('ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì…ë ¥ì°½ì— ì±„ì› ìŠµë‹ˆë‹¤.');
  } catch (e) {
    console.error(e);
    setExampleStatus('ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´ ê¸°ë³¸ ì˜ˆì‹œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'error');
    applyUsagePayload(exampleTemplate || FALLBACK_SAMPLE, { context: 'sample' });
  }
}
function handleExampleApply(){
  if (!exampleInput) return;
  try {
    const payload = JSON.parse(exampleInput.value || '{}');
    applyUsagePayload(payload, { context: 'example' });
    setExampleStatus('ì…ë ¥í•œ ê°’ìœ¼ë¡œ ì¸ì‚¬ì´íŠ¸ë¥¼ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.');
  } catch (err) {
    console.error(err);
    setExampleStatus('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
  }
}

function handleExampleFill(){
  if (!exampleInput) return;
  exampleInput.value = JSON.stringify(exampleTemplate || FALLBACK_SAMPLE, null, 2);
  setExampleStatus('ì˜ˆì‹œ ì…ë ¥ ê°’ìœ¼ë¡œ ì±„ì› ìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ì ìš© ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
}


function renderUsageKpis(insights){
  const grid = document.getElementById('usageKpis');
  if (!grid) return;
  const highest = insights.highestUsage;
  const lowest = insights.lowestUsage;
  const peak = insights.peakHour;
  const growth = insights.growthRate || { absolute: 0, percentage: 0 };
  const cards = [
    {
      title: 'ìµœê³  ì‚¬ìš© ì„¤ë¹„',
      value: highest ? highest.name : '-',
      sub: highest ? formatKwh(highest.total) : 'ë°ì´í„° ì¤€ë¹„ì¤‘',
    },
    {
      title: 'ìµœì € ì‚¬ìš© ì„¤ë¹„',
      value: lowest ? lowest.name : '-',
      sub: lowest ? formatKwh(lowest.total) : 'ë°ì´í„° ì¤€ë¹„ì¤‘',
    },
    {
      title: 'í‰ê·  ë¶€í•˜',
      value: formatKwh(insights.averageUsage || 0),
      sub: 'ì‹œê°„ëŒ€ í‰ê· ',
    },
    {
      title: 'í”¼í¬ ì‹œê°„ëŒ€',
      value: peak ? `${peak.hour}` : '-',
      sub: peak ? formatKwh(peak.kwh) : 'ë°ì´í„° ì¤€ë¹„ì¤‘',
    },
    {
      title: 'ì¦ê°ë¥ ',
      value: formatPercent(growth.percentage || 0),
      sub: `${growth.absolute >= 0 ? '+' : ''}${Math.round(growth.absolute || 0)} kWh`,
    },
  ];
  grid.innerHTML = cards.map(card => `
    <div class="insight-card">
      <div class="label">${card.title}</div>
      <div class="value">${card.value}</div>
      <div class="sub">${card.sub}</div>
    </div>
  `).join('');
}

function renderUsageChart(timeline){
  const canvas = document.getElementById('usageChart');
  if (!canvas) return;
  const labels = timeline.map(point => point.hour);
  const data = timeline.map(point => point.kwh);
  if (usageLineChart) usageLineChart.destroy();
  usageLineChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'kWh',
        data,
        borderColor: '#00b7ff',
        backgroundColor: 'rgba(0,183,255,0.15)',
        borderWidth: 2,
        tension: 0.35,
        fill: true,
        pointRadius: 3,
        pointBackgroundColor: '#5af6d6',
      }],
    },
    options: {
      plugins: {
        legend: { labels: { color: '#e6f0ff' } },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y.toLocaleString()} kWh`,
          },
        },
      },
      scales: {
        x: {
          ticks: { color: '#93a5c6' },
          grid: { color: 'rgba(255,255,255,0.08)' },
        },
        y: {
          ticks: { color: '#93a5c6' },
          grid: { color: 'rgba(255,255,255,0.08)' },
        },
      },
    },
  });
}

function renderFacilitySummary(rows){
  const wrap = document.getElementById('facilitySummary');
  if (!wrap) return;
  if (!rows.length) {
    wrap.innerHTML = '<p class="muted">ì„¤ë¹„ ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
    return;
  }
  wrap.innerHTML = rows.map(row => `
    <div class="facility-card">
      <div class="label">${row.name}</div>
      <div class="value">${formatKwh(row.total)}</div>
      <div class="sub tiny">ê¸°ì¤€ ${row.baseline?.toLocaleString?.() || row.baseline || '-'} kWh</div>
    </div>
  `).join('');
}

function renderUsageTips(tips){
  const list = document.getElementById('usageTips');
  if (!list) return;
  if (!tips.length) {
    list.innerHTML = '<li>ë“±ë¡ëœ ì ˆê° íŒì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    return;
  }
  list.innerHTML = '';
  tips.forEach(tip => {
    const li = document.createElement('li');
    li.textContent = tip;
    list.appendChild(li);
  });
}

/* -------------------------------
   ì‚°ì—…/ì—…ì¢… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
--------------------------------*/
async function loadCitiesTo(selectEl, metroCd) {
  selectEl.innerHTML = '<option value="">ì „ì²´(ì„ íƒ ì•ˆí•¨)</option>';
  selectEl.disabled = true;
  if (!metroCd) return;
  const {year, month} = getYM();
  try {
    const res = await axios.get(`/api/cities?year=${year}&month=${month}&metroCd=${metroCd}`);
    const cities = Array.isArray(res.data) ? res.data : [];
    for (const name of cities) {
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      selectEl.appendChild(opt);
    }
    selectEl.disabled = false;
  } catch (e) { console.error(e); }
}

async function loadIndustryTop(){
  const {year,month}=getYM();
  const metroCd=metroSel.value;
  const cityName=citySel.value;

  if(!metroCd || !cityName){ 
    alert('ì‹œë„ì™€ ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”'); 
    return; 
  }

  const limit=Number(topN.value||10);
  const qs=new URLSearchParams({year,month,limit});
  qs.set('metroCd', metroCd);
  qs.set('city', cityName);

  const res=await axios.get(`/api/industry/top?${qs}`);
  const rows=Array.isArray(res.data)?res.data:[];      
  if(!rows.length){ chart.clear(); chart.setOption({title:{text:'ë°ì´í„° ì—†ìŒ'}}); return; }

  const key=metricKey();
  const labels=rows.map(r=>r.biz||'(ë¯¸ë¶„ë¥˜)');
  const values=rows.map(r=>Number(r[key] ?? r.powerUsage ?? 0));
  renderBar(`${year}ë…„ ${month}ì›” ì‚°ì—…ë¶„ë¥˜ Top-${limit}${cityName? ' - '+cityName:''}`,labels,values,key);
}

async function loadBizType(){
  const {year,month}=getYM();
  const metroCd=metroSel2.value;
  const cityName=citySel2.value;
  if(!metroCd || !cityName){ alert('ì‹œë„ì™€ ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }

  const metroMap = {
    "11":"ì„œìš¸íŠ¹ë³„ì‹œ","26":"ë¶€ì‚°ê´‘ì—­ì‹œ","27":"ëŒ€êµ¬ê´‘ì—­ì‹œ","28":"ì¸ì²œê´‘ì—­ì‹œ","29":"ê´‘ì£¼ê´‘ì—­ì‹œ","30":"ëŒ€ì „ê´‘ì—­ì‹œ","31":"ìš¸ì‚°ê´‘ì—­ì‹œ","36":"ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ",
    "41":"ê²½ê¸°ë„","42":"ê°•ì›íŠ¹ë³„ìì¹˜ë„","43":"ì¶©ì²­ë¶ë„","44":"ì¶©ì²­ë‚¨ë„","45":"ì „ë¶íŠ¹ë³„ìì¹˜ë„","46":"ì „ë¼ë‚¨ë„","47":"ê²½ìƒë¶ë„","48":"ê²½ìƒë‚¨ë„","50":"ì œì£¼íŠ¹ë³„ìì¹˜ë„"
  };
  const metroName = metroMap[metroCd];

  const qs=new URLSearchParams({year,month,metro:metroName,city:cityName});
  const res=await axios.get(`/api/biztype?${qs}`);
  const rows=Array.isArray(res.data)?res.data:[]; 
  if(!rows.length){ chart.clear(); chart.setOption({title:{text:'ë°ì´í„° ì—†ìŒ'}}); return; }

  const key=metricKey();
  const agg={};
  rows.forEach(r=>{
    const n=r.bizType||'(ë¯¸ë¶„ë¥˜)';
    let val = 0;
    if (key === 'bill') {
      const raw = r.bill ?? r.charge ?? r.value ?? 0;
      val = Number(String(raw).replace(/,/g,'')) || 0;
    } else {
      const raw = r.powerUsage ?? r.kwh ?? 0;
      val = Number(String(raw).replace(/,/g,'')) || 0;
    }
    agg[n] = (agg[n] || 0) + val;
  });

  const labels = Object.keys(agg);
  const values = labels.map(k => agg[k]);
  renderBar(`${year}ë…„ ${month}ì›” ì—…ì¢…ë³„ (${metroName} ${cityName})`, labels, values, key);
}

/* -------------------------------
   ë§‰ëŒ€ì°¨íŠ¸ ë Œë”ë§
--------------------------------*/
function renderBar(title,labels,values,key){
  chart.setOption({
    title: {
      text: title,
      left: 'center',
      textStyle: { color: '#ffffff', fontWeight:'600' }
    },
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' },
      textStyle: { color: '#ffffff' },
      backgroundColor: 'rgba(0,0,0,0.7)',
      valueFormatter: v => key==='bill'?`${v.toLocaleString()} ì›`:`${v.toLocaleString()} kWh`
    },
    grid: { left:60, right:20, top:60, bottom:80 },
    xAxis: {
      type:'category',
      data: labels,
      axisLabel: { interval:0, rotate:30, color:'#ffffff' },
      axisLine: { lineStyle:{ color:'#ffffff' } },
      axisTick: { lineStyle:{ color:'#ffffff' } }
    },
    yAxis: {
      type:'value',
      name: key==='bill'?'ì›':'kWh',
      nameTextStyle: { color:'#ffffff' },
      axisLabel: { color:'#ffffff' },
      axisLine: { lineStyle:{ color:'#ffffff' } },
      splitLine: { lineStyle:{ color:'rgba(255,255,255,0.1)' } }
    },
    series: [{
      type:'bar',
      data: values,
      itemStyle: { color:'#2563eb' },
      label: { show:false}
    }]
  });
}

/* -------------------------------
   ì§€ë„ ì „ì²´ë³´ê¸° ë Œë”ë§
--------------------------------*/
async function renderMap(){
  industryRow.style.display = '';   // ì§€ë„ë„ industryRow ì˜ì—­ ì‚¬ìš©
  biztypeRow.style.display = 'none';

  const titleEl = industryRow.querySelector('.section-title');
  const toolbarEl = industryRow.querySelector('.toolbar');

  titleEl.textContent = 'ğŸ—º ì „êµ­ ì§€ë„ ë³´ê¸°';
  toolbarEl.style.display = 'none';
  metric.style.display = 'none';

  chart.clear();

  try {
    // ë¡œì»¬ GeoJSON ë¶ˆëŸ¬ì˜¤ê¸° (assets/korea.json)
    const res = await axios.get('assets/korea.json');
    echarts.registerMap('KOR', res.data);

    chart.setOption({
      tooltip: { trigger: 'item', formatter: '{b}' },
      visualMap: {
        min: 0,
        max: 100,
        left: 'left',
        top: 'bottom',
        text: ['ë§ìŒ','ì ìŒ'],
        calculable: true,
        inRange: { color: ['#e0f3f8','#08589e'] }
      },
      series: [{
        type: 'map',
        map: 'KOR',
        roam: true,
        emphasis: { label: { show: true } },
        data: []  // ì‹¤ì œ ê°’ì´ ìˆìœ¼ë©´ [{name:'ì„œìš¸íŠ¹ë³„ì‹œ', value:50}, ...]
      }]
    });
  } catch(e) {
    chart.setOption({ title:{text:'ì§€ë„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'} });
    console.error(e);
  }
}

/* -------------------------------
   DOM ìš”ì†Œ
--------------------------------*/
const year=document.getElementById('year');
const month=document.getElementById('month');
const metric=document.getElementById('metric');
const metricLabel=document.getElementById('metricLabel');
const topN=document.getElementById('topN');
const metroSel=document.getElementById('metroSel');
const citySel=document.getElementById('citySel');
const metroSel2=document.getElementById('metroSel2');
const citySel2=document.getElementById('citySel2');
const btnIndustry=document.getElementById('btnIndustry');
const btnBizType=document.getElementById('btnBizType');
const btnMap=document.getElementById('btnMap');
const industryRow=document.getElementById('industryRow');
const biztypeRow=document.getElementById('biztypeRow');

/* -------------------------------
   í†µí•© ëª¨ë“œ ê´€ë¦¬
--------------------------------*/
function setMode(mode){
  btnIndustry.className = `mode-btn ${mode==='industry' ? 'primary' : 'ghost'}`;
  btnBizType.className  = `mode-btn ${mode==='biztype' ? 'primary' : 'ghost'}`;
  btnMap.classList.toggle('active', mode==='map');


  if(mode==='map'){
    renderMap();
  } else if(mode==='industry'){
    industryRow.style.display = '';
    biztypeRow.style.display = 'none';

    const titleEl = industryRow.querySelector('.section-title');
    const toolbarEl = industryRow.querySelector('.toolbar');

    titleEl.textContent = 'ì‚°ì—…ë¶„ë¥˜ Top-N ì¡°íšŒ';
    toolbarEl.style.display = '';
    metric.style.display = '';
    const billOption = metric.querySelector('option[value="bill"]');
    billOption.style.display = '';
    chart.clear();
  } else if(mode==='biztype'){
    industryRow.style.display = 'none';
    biztypeRow.style.display  = '';
    const billOption = metric.querySelector('option[value="bill"]');
    metric.value = 'kwh';
    billOption.style.display = 'none';
    chart.clear();
  }
}

/* -------------------------------
   ì´ë²¤íŠ¸
--------------------------------*/
btnIndustry.onclick = ()=> setMode('industry');
btnBizType.onclick  = ()=> setMode('biztype');
btnMap.onclick      = ()=> setMode('map');
btnExampleApply?.addEventListener('click', handleExampleApply);
btnExampleFill?.addEventListener('click', handleExampleFill);
document.getElementById('btnIndustryLoad').onclick = loadIndustryTop;
document.getElementById('btnBizLoad').onclick     = loadBizType;
metroSel.addEventListener('change', ()=> loadCitiesTo(citySel, metroSel.value));
metroSel2.addEventListener('change', ()=> loadCitiesTo(citySel2, metroSel2.value));

setMode('industry');
fetchUsageInsights();
</script>



</body>
</html>
