<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì „ë ¥ ì‚¬ìš©ëŸ‰ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <style>
    body { font-family: ui-sans-serif,system-ui,AppleSDGothicNeo,Malgun Gothic,sans-serif; margin: 24px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    input, select, button { padding:8px 10px; font-size:14px; }
    button.primary { background:#111827; color:#fff; border:0; border-radius:6px; }
    button.ghost { background:#fff; color:#111827; border:1px solid #e5e7eb; border-radius:6px; }
    #chart { width: 100%; height: 600px; margin-top: 12px; }
    #mapChart { width: 100%; height: 600px; margin-top: 24px; }
    .hint { color:#6b7280; font-size:12px; margin-left:4px; }
    .row strong { font-size:16px; }
  </style>
</head>
<body>
  <h2>ğŸ“Š ì „ë ¥ ì‚¬ìš©ëŸ‰ ëŒ€ì‹œë³´ë“œ</h2>

  <!-- ê³µí†µ ì…ë ¥ -->
  <div class="row">
    <label>ì—°ë„ <input id="year" type="text" placeholder="ì˜ˆ: 2020" value="2020"></label>
    <label>ì›” <input id="month" type="text" placeholder="ì˜ˆ: 11" value="11"></label>
    <select id="metric">
      <option value="kwh" selected>kWh(ì „ë ¥ì‚¬ìš©ëŸ‰)</option>
      <option value="bill">ìš”ê¸ˆ(ì›)</option>
    </select>
    <button class="primary" id="btnIndustry">ì‚°ì—…ë¶„ë¥˜ Top-N</button>
    <button class="ghost" id="btnBizType">ì—…ì¢…ë³„(ì‹œêµ°êµ¬)</button>
  </div>

  <!-- ì‚°ì—…ë¶„ë¥˜ Top-N -->
  <div class="row" id="industryRow">
    <label>Top N <input id="topN" type="number" min="3" max="30" value="10" style="width:80px"></label>

    <!-- metroCd ì„ íƒ -->
    <label>ì‹œë„
      <select id="metroSel">
        <option value="">ì „ì²´(ì„ íƒ ì•ˆí•¨)</option>
        <option value="11">ì„œìš¸íŠ¹ë³„ì‹œ</option>
        <option value="26">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
        <option value="27">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
        <option value="28">ì¸ì²œê´‘ì—­ì‹œ</option>
        <option value="29">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
        <option value="30">ëŒ€ì „ê´‘ì—­ì‹œ</option>
        <option value="31">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
        <option value="36">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
        <option value="41">ê²½ê¸°ë„</option>
        <option value="42">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
        <option value="43">ì¶©ì²­ë¶ë„</option>
        <option value="44">ì¶©ì²­ë‚¨ë„</option>
        <option value="45">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
        <option value="46">ì „ë¼ë‚¨ë„</option>
        <option value="47">ê²½ìƒë¶ë„</option>
        <option value="48">ê²½ìƒë‚¨ë„</option>
        <option value="50">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
      </select>
    </label>

    <!-- ì‹œêµ°êµ¬(ì´ë¦„) ì„ íƒ -->
    <label>ì‹œêµ°êµ¬
      <select id="citySel" disabled>
        <option value="">ì „ì²´(ì„ íƒ ì•ˆí•¨)</option>
      </select>
    </label>

    <button class="primary" id="btnIndustryLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>

  <!-- ì—…ì¢…ë³„(ì‹œêµ°êµ¬) -->
  <div class="row" id="biztypeRow" style="display:none">
    <label>ì‹œë„
      <select id="metroSel2">
        <option value="">ì‹œë„ ì„ íƒ</option>
        <option value="11">ì„œìš¸íŠ¹ë³„ì‹œ</option>
        <option value="26">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
        <option value="27">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
        <option value="28">ì¸ì²œê´‘ì—­ì‹œ</option>
        <option value="29">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
        <option value="30">ëŒ€ì „ê´‘ì—­ì‹œ</option>
        <option value="31">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
        <option value="36">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
        <option value="41">ê²½ê¸°ë„</option>
        <option value="42">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
        <option value="43">ì¶©ì²­ë¶ë„</option>
        <option value="44">ì¶©ì²­ë‚¨ë„</option>
        <option value="45">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
        <option value="46">ì „ë¼ë‚¨ë„</option>
        <option value="47">ê²½ìƒë¶ë„</option>
        <option value="48">ê²½ìƒë‚¨ë„</option>
        <option value="50">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
      </select>
    </label>

    <label>ì‹œêµ°êµ¬
      <select id="citySel2" disabled>
        <option value="">ì‹œêµ°êµ¬ ì„ íƒ</option>
      </select>
    </label>

    <label>ì—…ì¢…ëª…(ì„ íƒ) <input id="bizType" type="text" placeholder="ì˜ˆ: ì„¬ìœ "></label>
    <button class="primary" id="btnBizLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>

  <!-- ì œì¡°ì—… ì§€ë„ -->
  <div class="row" id="manuMapRow">
    <strong>í–‰ì •êµ¬ì—­ ì œì¡°ì—… ì§€ë„</strong>
    <span class="hint">í–‰ì •êµ¬ì—­ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì œì¡°ì—… ì „ë ¥ì‚¬ìš©ëŸ‰ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</span>
    <label>ì‹œë„
      <select id="mapMetroSel">
        <option value="">ì‹œë„ ì„ íƒ</option>
        <option value="11">ì„œìš¸íŠ¹ë³„ì‹œ</option>
        <option value="26">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
        <option value="27">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
        <option value="28">ì¸ì²œê´‘ì—­ì‹œ</option>
        <option value="29">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
        <option value="30">ëŒ€ì „ê´‘ì—­ì‹œ</option>
        <option value="31">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
        <option value="36">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
        <option value="41">ê²½ê¸°ë„</option>
        <option value="42">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
        <option value="43">ì¶©ì²­ë¶ë„</option>
        <option value="44">ì¶©ì²­ë‚¨ë„</option>
        <option value="45">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
        <option value="46">ì „ë¼ë‚¨ë„</option>
        <option value="47">ê²½ìƒë¶ë„</option>
        <option value="48">ê²½ìƒë‚¨ë„</option>
        <option value="50">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
      </select>
    </label>
    <button class="primary" id="btnMapLoad">ì§€ë„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>

  <div id="mapChart"></div>
  <div id="chart"></div>

  <script>
    const chart = echarts.init(document.getElementById('chart'));
    const mapChart = echarts.init(document.getElementById('mapChart'));
    const z2 = (m)=>String(m??'').padStart(2,'0');
    const getYM = ()=>({ year:year.value.trim(), month:z2(month.value.trim()) });
    const metricKey = ()=>metric.value;

    const metroMap = {
      "11":"ì„œìš¸íŠ¹ë³„ì‹œ","26":"ë¶€ì‚°ê´‘ì—­ì‹œ","27":"ëŒ€êµ¬ê´‘ì—­ì‹œ","28":"ì¸ì²œê´‘ì—­ì‹œ","29":"ê´‘ì£¼ê´‘ì—­ì‹œ","30":"ëŒ€ì „ê´‘ì—­ì‹œ","31":"ìš¸ì‚°ê´‘ì—­ì‹œ","36":"ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ",
      "41":"ê²½ê¸°ë„","42":"ê°•ì›íŠ¹ë³„ìì¹˜ë„","43":"ì¶©ì²­ë¶ë„","44":"ì¶©ì²­ë‚¨ë„","45":"ì „ë¶íŠ¹ë³„ìì¹˜ë„","46":"ì „ë¼ë‚¨ë„","47":"ê²½ìƒë¶ë„","48":"ê²½ìƒë‚¨ë„","50":"ì œì£¼íŠ¹ë³„ìì¹˜ë„"
    };

    const metroGeoMeta = {
      "11":{ name: metroMap["11"], file:"hangjeongdong_ì„œìš¸íŠ¹ë³„ì‹œ.json", mapKey:"hangjeong-11" },
      "26":{ name: metroMap["26"], file:"hangjeongdong_ë¶€ì‚°ê´‘ì—­ì‹œ.json", mapKey:"hangjeong-26" },
      "27":{ name: metroMap["27"], file:"hangjeongdong_ëŒ€êµ¬ê´‘ì—­ì‹œ.json", mapKey:"hangjeong-27" },
      "28":{ name: metroMap["28"], file:"hangjeongdong_ì¸ì²œê´‘ì—­ì‹œ.json", mapKey:"hangjeong-28" },
      "29":{ name: metroMap["29"], file:"hangjeongdong_ê´‘ì£¼ê´‘ì—­ì‹œ.json", mapKey:"hangjeong-29" },
      "30":{ name: metroMap["30"], file:"hangjeongdong_ëŒ€ì „ê´‘ì—­ì‹œ.json", mapKey:"hangjeong-30" },
      "31":{ name: metroMap["31"], file:"hangjeongdong_ìš¸ì‚°ê´‘ì—­ì‹œ.json", mapKey:"hangjeong-31" },
      "36":{ name: metroMap["36"], file:"hangjeongdong_ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ.json", mapKey:"hangjeong-36" },
      "41":{ name: metroMap["41"], file:"hangjeongdong_ê²½ê¸°ë„.json", mapKey:"hangjeong-41" },
      "42":{ name: metroMap["42"], file:"hangjeongdong_ê°•ì›ë„.json", mapKey:"hangjeong-42" },
      "43":{ name: metroMap["43"], file:"hangjeongdong_ì¶©ì²­ë¶ë„.json", mapKey:"hangjeong-43" },
      "44":{ name: metroMap["44"], file:"hangjeongdong_ì¶©ì²­ë‚¨ë„.json", mapKey:"hangjeong-44" },
      "45":{ name: metroMap["45"], file:"hangjeongdong_ì „ë¼ë¶ë„.json", mapKey:"hangjeong-45" },
      "46":{ name: metroMap["46"], file:"hangjeongdong_ì „ë¼ë‚¨ë„.json", mapKey:"hangjeong-46" },
      "47":{ name: metroMap["47"], file:"hangjeongdong_ê²½ìƒë¶ë„.json", mapKey:"hangjeong-47" },
      "48":{ name: metroMap["48"], file:"hangjeongdong_ê²½ìƒë‚¨ë„.json", mapKey:"hangjeong-48" },
      "50":{ name: metroMap["50"], file:"hangjeongdong_ì œì£¼íŠ¹ë³„ìì¹˜ë„.json", mapKey:"hangjeong-50" }
    };

    const geoCache = {};

    async function loadGeoJson(metroCd){
      if(geoCache[metroCd]) return geoCache[metroCd];
      const meta = metroGeoMeta[metroCd];
      if(!meta) throw new Error('í•´ë‹¹ ì‹œë„ì˜ ì§€ë„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      const resp = await fetch(`/hangjeongdong/${meta.file}`);
      if(!resp.ok) throw new Error('ì§€ë„ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      const data = await resp.json();
      geoCache[metroCd] = data;
      return data;
    }

    async function loadManufacturingMap(){
      const {year,month}=getYM();
      const metroCd=mapMetroSel.value;
      if(!metroCd){ alert('ì‹œë„ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
      const meta = metroGeoMeta[metroCd];
      if(!meta){ alert('í•´ë‹¹ ì‹œë„ì˜ ì§€ë„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

      mapChart.showLoading('default',{text:'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'});
      try {
        const [geoJson,res] = await Promise.all([
          loadGeoJson(metroCd),
          axios.get(`/api/manufacturing/map?year=${year}&month=${month}&metroCd=${metroCd}`)
        ]);

        echarts.registerMap(meta.mapKey, geoJson);
        const items = Array.isArray(res.data?.items)?res.data.items:[];

        if(!items.length){
          mapChart.hideLoading();
          mapChart.clear();
          mapChart.setOption({title:{text:'ë°ì´í„° ì—†ìŒ',left:'center',top:'middle'}});
          return;
        }

        const valueByCity={};
        items.forEach(item=>{
          const city=(item.city||'').trim();
          if(!city) return;
          const val=Number(item.kwh ?? item.powerUsage ?? 0);
          if(Number.isNaN(val)) return;
          valueByCity[city]=(valueByCity[city]||0)+val;
        });

        const seriesData=(geoJson.features||[]).map(f=>{
          const props=f.properties||{};
          const city=(props.sggnm||props.sig_kor_nm||'').trim();
          const fallback=(props.adm_nm||'').trim();
          const key=city||fallback;
          const val = city && valueByCity[city]!=null ? valueByCity[city] : null;
          return { name: key, value: val, cityName: city||fallback || 'ì•Œìˆ˜ì—†ìŒ' };
        });
        const values=seriesData.map(d=>d.value).filter(v=>typeof v==='number' && !Number.isNaN(v));
        const maxVal=values.length?Math.max(...values):0;

        mapChart.hideLoading();
        mapChart.setOption({
          title:{text:`${year}ë…„ ${month}ì›” ì œì¡°ì—… ì „ë ¥ì‚¬ìš©ëŸ‰ (${meta.name})`,left:'center'},
          tooltip:{
            trigger:'item',
            formatter:params=>{
              const city=params.data?.cityName || params.name;
              const value=params.value;
              if(value==null || Number.isNaN(value)) return `${city}: ë°ì´í„° ì—†ìŒ`;
              return `${city}: ${Number(value).toLocaleString()} kWh`;
            }
          },
          visualMap: values.length ? {
            min:0,
            max:maxVal || 1,
            left:10,
            bottom:20,
            text:['ë§ìŒ','ì ìŒ'],
            calculable:true,
            inRange:{ color:['#dbeafe','#3b82f6'] }
          } : { show:false },
          series:[{
            name:'ì œì¡°ì—…',
            type:'map',
            map:meta.mapKey,
            roam:true,
            label:{ show:false },
            data:seriesData,
            emphasis:{ label:{ show:true }, itemStyle:{ areaColor:'#2563eb' } }
          }]
        });
      } catch (e) {
        console.error(e);
        mapChart.hideLoading();
        alert('ì œì¡°ì—… ì§€ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì‹œêµ°êµ¬ ëª©ë¡ ë¡œë“œ (ì´ë¦„ ë°°ì—´)
    async function loadCitiesTo(selectEl, metroCd) {
      selectEl.innerHTML = '<option value="">ì „ì²´(ì„ íƒ ì•ˆí•¨)</option>';
      selectEl.disabled = true;
      if (!metroCd) return;
      const {year, month} = getYM();
      try {
        const res = await axios.get(`/api/cities?year=${year}&month=${month}&metroCd=${metroCd}`);
        const cities = Array.isArray(res.data) ? res.data : [];
        for (const name of cities) {
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          selectEl.appendChild(opt);
        }
        selectEl.disabled = false;
      } catch (e) {
        console.error(e);
      }
    }

    // ì‚°ì—…ë¶„ë¥˜ Top-N
    async function loadIndustryTop(){
      const {year,month}=getYM();
      const metroCd=metroSel.value; // ì½”ë“œ
      const cityName=citySel.value;  // ì´ë¦„(ì„ íƒ ì•ˆ í•˜ë©´ ë¹ˆ)
      const limit=Number(topN.value||10);
      const qs=new URLSearchParams({year,month,limit});
      if(metroCd) qs.set('metroCd', metroCd);
      if(cityName) qs.set('city', cityName); // ì´ë¦„ í•„í„°

      const res=await axios.get(`/api/industry/top?${qs}`);
      const rows=Array.isArray(res.data)?res.data:[];
      if(!rows.length){ chart.clear(); chart.setOption({title:{text:'ë°ì´í„° ì—†ìŒ'}}); return; }

      const key=metricKey();
      const labels=rows.map(r=>r.biz||'(ë¯¸ë¶„ë¥˜)');
      const values=rows.map(r=>Number(r[key]||r.powerUsage||0));
      renderBar(`${year}ë…„ ${month}ì›” ì‚°ì—…ë¶„ë¥˜ Top-${limit}${cityName? ' - '+cityName:''}`,labels,values,key);
    }

    // ì—…ì¢…ë³„(ì‹œêµ°êµ¬)
    async function loadBizType(){
      const {year,month}=getYM();
      const metroCd=metroSel2.value;
      const cityName=citySel2.value;
      if(!metroCd || !cityName){ alert('ì‹œë„ì™€ ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }

      const metroName = metroMap[metroCd];

      const bizType=bizTypeEl.value.trim();
      const qs=new URLSearchParams({year,month,metro:metroName,city:cityName});
      if(bizType) qs.set('bizType', bizType);

      const res=await axios.get(`/api/biztype?${qs}`);
      const rows=Array.isArray(res.data)?res.data:[];
      if(!rows.length){ chart.clear(); chart.setOption({title:{text:'ë°ì´í„° ì—†ìŒ'}}); return; }

      const key=metricKey();
      const agg={};
      rows.forEach(r=>{
        const n=r.bizType||'(ë¯¸ë¶„ë¥˜)';
        const val=(key==='bill'?Number(r.bill??0):Number(r.powerUsage??r.kwh??0));
        agg[n]=(agg[n]||0)+val;
      });
      const labels=Object.keys(agg);
      const values=labels.map(k=>agg[k]);
      renderBar(`${year}ë…„ ${month}ì›” ì—…ì¢…ë³„ (${metroName} ${cityName})`,labels,values,key);
    }

    function renderBar(title,labels,values,key){
      chart.setOption({
        title:{text:title,left:'center'},
        tooltip:{trigger:'axis', valueFormatter:v=>key==='bill'?`${v.toLocaleString()} ì›`:`${v.toLocaleString()} kWh`},
        grid:{left:60,right:20,top:60,bottom:80},
        xAxis:{type:'category',data:labels,axisLabel:{interval:0,rotate:30}},
        yAxis:{type:'value',name:key==='bill'?'ì›':'kWh'},
        series:[{type:'bar',data:values}]
      });
    }

    // ìš”ì†Œ ì°¸ì¡°
    const year=document.getElementById('year');
    const month=document.getElementById('month');
    const metric=document.getElementById('metric');

    // ì‚°ì—…ë¶„ë¥˜ìš©
    const topN=document.getElementById('topN');
    const metroSel=document.getElementById('metroSel');
    const citySel=document.getElementById('citySel');

    // ì—…ì¢…ë³„ìš©
    const metroSel2=document.getElementById('metroSel2');
    const citySel2=document.getElementById('citySel2');
    const bizTypeEl=document.getElementById('bizType');

    // ì§€ë„ìš©
    const mapMetroSel=document.getElementById('mapMetroSel');
    const btnMapLoad=document.getElementById('btnMapLoad');

    // ë²„íŠ¼/ëª¨ë“œ ì „í™˜
    const btnIndustry=document.getElementById('btnIndustry');
    const btnBizType=document.getElementById('btnBizType');
    const industryRow=document.getElementById('industryRow');
    const biztypeRow=document.getElementById('biztypeRow');

    function setMode(mode){
      btnIndustry.className = mode==='industry'?'primary':'ghost';
      btnBizType.className  = mode==='biztype'?'primary':'ghost';
      industryRow.style.display = mode==='industry'?'':'none';
      biztypeRow.style.display  = mode==='biztype'?'':'none';
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    btnIndustry.onclick = ()=> setMode('industry');
    btnBizType.onclick  = ()=> setMode('biztype');
    document.getElementById('btnIndustryLoad').onclick = loadIndustryTop;
    document.getElementById('btnBizLoad').onclick     = loadBizType;
    btnMapLoad.onclick = loadManufacturingMap;

    // ì‹œë„ ì„ íƒ â†’ ì‹œêµ°êµ¬ ëª©ë¡ ë¡œë“œ
    metroSel.addEventListener('change', ()=> loadCitiesTo(citySel, metroSel.value));
    metroSel2.addEventListener('change', ()=> loadCitiesTo(citySel2, metroSel2.value));

    // ì´ˆê¸° ëª¨ë“œ
    setMode('industry');
  </script>
</body>
</html>
